{"files":[{"id":"cc3e6b8e-5e25-4378-9f86-949bfc71eb73","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"America/Los_Angeles\",\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"dependencies\": {\n    \"enabledAdvancedServices\": [\n      {\n        \"userSymbol\": \"Gmail\",\n        \"serviceId\": \"gmail\",\n        \"version\": \"v1\"\n      }\n    ],\n    \"libraries\": [\n      {\n        \"userSymbol\": \"ESGlobal\",\n        \"version\": \"0\",\n        \"libraryId\": \"1QCGr31jK3EUGzlUSnrjoxWa0dS-Dp-2JnJXkokoK6_IZkQxiXgW3szua\",\n        \"developmentMode\": true\n      }\n    ]\n  }\n}"},{"id":"465b989c-c9a9-4106-a08d-7ead10b38dc4","name":"Main","type":"server_js","source":"function onStudentSubmit(email, name, homeroom, destination, purpose) {\n  const homeroomTeacher \u003d homeroom.split(\" @ \")[0];\n  const destinationTeacher \u003d destination.split(\" @ \")[0];\n  const homeTeacherData \u003d ESGlobal.accessTeacherDB().getData(homeroomTeacher);\n  const destTeacherData \u003d\n    ESGlobal.accessTeacherDB().getData(destinationTeacher);\n\n  const homeroomSheetId \u003d homeTeacherData[0];\n  const destinationSheetId \u003d destTeacherData[0];\n\n  let isAuto \u003d destTeacherData[4];\n  let isSubstitute \u003d destTeacherData[5];\n\n  const studentBundle \u003d {\n    email: email,\n    name: name,\n    homeroom: homeroom,\n    destination: destination,\n    purpose: purpose,\n  };\n\n  const teacherBundle \u003d {\n    destSheetId: destinationSheetId,\n    destTeacher: destinationTeacher,\n    homeSheetId: homeroomSheetId,\n    homeTeacher: homeroomTeacher,\n  };\n\n  let alreadySubmit \u003d ESGlobal.accessStudentDB().dataExists(email); //use data exists to ensure data exists, difficulty persists with getData\n  if (alreadySubmit) {\n    //prevents spam\n    if (alreadySubmit[2] \u003d\u003d homeroom \u0026\u0026 alreadySubmit[3] \u003d\u003d destination) {\n      ESGlobal.handleReject(\n        teacherBundle,\n        studentBundle,\n        \"Your current request has been processed previously.\"\n      );\n      return;\n    }\n    //teacher requested the student-\u003e can\u0027t make another request\n    if (alreadySubmit[5] !\u003d \"_PENDING_\" \u0026\u0026 alreadySubmit[5] !\u003d \"_ACCEPTED_\") {\n      ESGlobal.handleReject(\n        teacherBundle,\n        studentBundle,\n        \"You are requested by \" + alreadySubmit[5]\n      );\n      return;\n    } else {\n      ESGlobal.handleSubmitted(alreadySubmit);\n    }\n  }\n\n  if (isAuto) {\n    let isFull \u003d ESGlobal.accessTeacherDB().isTeacherFull(destinationTeacher);\n    if (isFull) {\n      ESGlobal.handleReject(teacherBundle, studentBundle, \"Full room\", false);\n      return;\n    }\n  } else if (isSubstitute) {\n    ESGlobal.handleReject(teacherBundle, studentBundle, \"Teacher absent\", false);\n    return;\n  }\n  ESGlobal.handlePending(teacherBundle, studentBundle);\n}\n"}]}